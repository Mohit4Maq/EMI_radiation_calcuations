<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PCB EMI Loop Radiation Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c10;
    --panel: #0d1520;
    --border: #1a2d40;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --warn: #ffcc00;
    --danger: #ff2d55;
    --safe: #00ff88;
    --text: #c8dde8;
    --dim: #8ab4c8;
    --glow: 0 0 20px rgba(0,229,255,0.3);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    padding: 20px;
    background-image: 
      radial-gradient(ellipse at 20% 20%, rgba(0,100,150,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(255,107,53,0.05) 0%, transparent 60%),
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 100% 100%, 100% 100%, 30px 30px, 30px 30px;
  }
  h1 {
    font-family: 'Orbitron', monospace;
    font-weight: 900;
    font-size: clamp(16px, 3vw, 28px);
    color: var(--accent);
    text-shadow: var(--glow);
    letter-spacing: 3px;
    margin-bottom: 4px;
  }
  .subtitle {
    color: var(--dim);
    font-size: 12px;
    letter-spacing: 2px;
    margin-bottom: 24px;
  }
  .layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
    max-width: 1200px;
    margin: 0 auto;
  }
  @media (max-width: 800px) {
    .layout { grid-template-columns: 1fr; }
  }
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  .panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }
  .panel-title {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    color: var(--accent);
    letter-spacing: 3px;
    margin-bottom: 20px;
    opacity: 0.7;
  }
  .param-group { margin-bottom: 20px; }
  .param-label {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 6px;
    font-size: 11px;
    color: var(--dim);
    letter-spacing: 1px;
  }
  .param-label span:last-child {
    font-size: 14px;
    color: var(--accent);
    font-family: 'Orbitron', monospace;
  }
  input[type=range] {
    width: 100%;
    -webkit-appearance: none;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 10px var(--accent);
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-runnable-track {
    height: 4px;
    background: linear-gradient(90deg, var(--accent) var(--pct, 50%), var(--border) var(--pct, 50%));
    border-radius: 2px;
  }
  .param-range-labels {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    color: #8ab4c8;
    margin-top: 2px;
  }
  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 16px 0;
  }
  .result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .result-row:last-child { border-bottom: none; }
  .result-label { font-size: 10px; color: var(--dim); letter-spacing: 1px; }
  .result-val {
    font-family: 'Orbitron', monospace;
    font-size: 16px;
    font-weight: 700;
  }
  .gauge-container {
    margin: 20px 0;
    position: relative;
  }
  .gauge-label {
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 2px;
    margin-bottom: 8px;
  }
  .gauge-bar {
    height: 28px;
    background: var(--border);
    border-radius: 2px;
    position: relative;
    overflow: hidden;
  }
  .gauge-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s ease, background 0.3s ease;
    position: relative;
  }
  .gauge-fill::after {
    content: '';
    position: absolute;
    top: 0; right: 0; bottom: 0;
    width: 4px;
    background: white;
    box-shadow: 0 0 8px white;
  }
  .limit-marker {
    position: absolute;
    top: 0; bottom: 0;
    width: 2px;
    background: var(--warn);
    box-shadow: 0 0 6px var(--warn);
  }
  .limit-marker-label {
    position: absolute;
    top: -16px;
    transform: translateX(-50%);
    font-size: 8px;
    color: var(--warn);
    white-space: nowrap;
  }
  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 2px;
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    margin-top: 8px;
  }
  canvas {
    width: 100%;
    background: transparent;
    border-radius: 2px;
  }
  .chart-container {
    position: relative;
    margin-top: 10px;
  }
  .chart-title {
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 2px;
    margin-bottom: 8px;
  }
  .legend {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--dim);
  }
  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }
  .loop-visual {
    position: relative;
    height: 160px;
    margin: 16px 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  svg text { font-family: 'Share Tech Mono', monospace; }
  .info-box {
    background: rgba(0,229,255,0.05);
    border: 1px solid rgba(0,229,255,0.15);
    border-radius: 2px;
    padding: 10px 12px;
    font-size: 10px;
    color: var(--dim);
    line-height: 1.7;
    margin-top: 12px;
  }
  .info-box strong { color: var(--accent); }
</style>
</head>
<body>

<div style="max-width:1200px; margin:0 auto;">
  <h1>PCB EMI LOOP RADIATION</h1>
  <div class="subtitle">MAGNETIC DIPOLE FIELD STRENGTH CALCULATOR · CISPR CLASS B COMPLIANCE</div>

  <!-- PROBLEM STATEMENT SECTION -->
  <div class="panel" style="margin-bottom:16px;">
    <div style="display:grid;grid-template-columns:1fr 400px;gap:28px;align-items:start;">

      <!-- Left: text -->
      <div>
        <div style="font-family:'Orbitron',monospace;font-size:9px;color:var(--accent2);letter-spacing:3px;margin-bottom:10px;">THE PROBLEM WE ARE SOLVING</div>
        <div style="font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:#e0f4ff;line-height:1.5;margin-bottom:14px;">
          What value &amp; position of series resistor in a bootstrap RC circuit minimises radiated EMI?
        </div>
        <div style="font-size:12px;color:#8ab4c8;line-height:1.9;">
          In gate-drive and bootstrap circuits, a capacitor pre-charged to supply voltage V is switched into a load through a series resistor R. At the moment of switching, the capacitor discharges and drives a fast current pulse &mdash; a high <span style="color:var(--accent);">di/dt</span> event &mdash; through whatever loop the PCB layout creates.<br><br>
          This current loop behaves as a <span style="color:var(--accent);">magnetic dipole antenna</span>. The resistor R is the critical design variable because it simultaneously controls three parameters that govern EMI:
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:14px 0;">
          <div style="background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.2);border-radius:3px;padding:10px;">
            <div style="font-family:'Orbitron',monospace;font-size:8px;color:var(--accent);margin-bottom:6px;letter-spacing:1px;">PEAK CURRENT</div>
            <div style="font-size:13px;color:#e0f4ff;font-family:'Share Tech Mono',monospace;">I = V / R</div>
            <div style="font-size:10px;color:var(--dim);margin-top:4px;">Larger R reduces I linearly</div>
          </div>
          <div style="background:rgba(255,107,53,0.06);border:1px solid rgba(255,107,53,0.2);border-radius:3px;padding:10px;">
            <div style="font-family:'Orbitron',monospace;font-size:8px;color:var(--accent2);margin-bottom:6px;letter-spacing:1px;">RISE TIME</div>
            <div style="font-size:13px;color:#e0f4ff;font-family:'Share Tech Mono',monospace;">t&#7523; = 2.2RC</div>
            <div style="font-size:10px;color:var(--dim);margin-top:4px;">Larger R slows edges, cuts harmonics</div>
          </div>
          <div style="background:rgba(255,45,85,0.06);border:1px solid rgba(255,45,85,0.2);border-radius:3px;padding:10px;">
            <div style="font-family:'Orbitron',monospace;font-size:8px;color:var(--danger);margin-bottom:6px;letter-spacing:1px;">EMI FIELD</div>
            <div style="font-size:13px;color:#e0f4ff;font-family:'Share Tech Mono',monospace;">E &#8733; I &middot; f&sup2;</div>
            <div style="font-size:10px;color:var(--dim);margin-top:4px;">R reduces E from both effects</div>
          </div>
        </div>

        <div style="font-size:12px;color:#8ab4c8;line-height:1.9;">
          The <span style="color:var(--warn);">trade-off</span>: R too small &rarr; fast harsh switching, large EMI spike, MOSFET gate stress. R too large &rarr; slow gate drive, excess thermal loss (P = &frac12;CV&sup2;&middot;f&#8320; per cycle) and potential bootstrap timing issues. Use the calculator below to find the optimal balance.
        </div>
      </div>

      <!-- Right: SVG circuit diagram -->
      <div>
        <div style="font-size:9px;color:#8ab4c8;letter-spacing:2px;margin-bottom:8px;">HALF-BRIDGE BOOTSTRAP CIRCUIT — STANDARD TOPOLOGY</div>

        <div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:8px;font-size:9px;">
          <span style="color:#00ff88;">&#9473;&#9473; Charge path (Q_LS ON, SW=GND)</span>
          <span style="color:#ff6b35;">&#9473;&#9473; Discharge / di/dt path (Q_HS turns ON)</span>
          <span style="color:#ff2d55;">&#9135; &#9135; PCB loop = radiating antenna</span>
        </div>

        <svg viewBox="0 0 540 400" style="width:100%;background:rgba(0,0,0,0.28);border-radius:3px;border:1px solid var(--border);" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <marker id="aG" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,1 L7,4 L0,7 Z" fill="#00ff88"/></marker>
            <marker id="aO" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,1 L7,4 L0,7 Z" fill="#ff6b35"/></marker>
            <filter id="glo"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            <filter id="gloR"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>

          <!-- ══════════════════════════════════════════ -->
          <!--  POWER BUS                                 -->
          <!-- ══════════════════════════════════════════ -->
          <!-- HV Bus top (motor bus / battery) -->
          <line x1="30" y1="25" x2="510" y2="25" stroke="#2a4060" stroke-width="2"/>
          <text x="32" y="17" fill="#4a6070" font-size="8" font-family="Share Tech Mono,monospace">HV BUS (V_BUS)</text>

          <!-- GND bottom -->
          <line x1="30" y1="375" x2="510" y2="375" stroke="#2a4060" stroke-width="2"/>
          <text x="32" y="388" fill="#4a6070" font-size="8" font-family="Share Tech Mono,monospace">GND / POWER GROUND</text>

          <!-- VCC supply (gate driver bias, separate from HV bus) -->
          <!-- VCC node at x=90, comes in from left -->
          <line x1="30" y1="70" x2="90" y2="70" stroke="#1a3050" stroke-width="1.5"/>
          <text x="32" y="65" fill="#8ab4c8" font-size="8" font-family="Share Tech Mono,monospace">VCC (bias)</text>
          <!-- VCC decoupling cap C_VCC -->
          <line x1="55" y1="70"  x2="55" y2="88"  stroke="#8ab4c8" stroke-width="1.5"/>
          <line x1="40" y1="88"  x2="70" y2="88"  stroke="#8ab4c8" stroke-width="2.5"/>
          <line x1="40" y1="97"  x2="70" y2="97"  stroke="#8ab4c8" stroke-width="2.5"/>
          <line x1="55" y1="97"  x2="55" y2="115" stroke="#8ab4c8" stroke-width="1.5"/>
          <line x1="55" y1="115" x2="55" y2="375" stroke="#2a4060" stroke-width="1.5" stroke-dasharray="3,4"/>
          <text x="73" y="90" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">C_VCC</text>
          <text x="73" y="100" fill="#4a6070" font-size="7" font-family="Share Tech Mono,monospace">1µF X7R</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  R_BOOT: VCC → R_BOOT → anode of D_BOOT   -->
          <!-- ══════════════════════════════════════════ -->
          <line x1="90" y1="70" x2="108" y2="70" stroke="#ff6b35" stroke-width="2"/>
          <!-- Zigzag R_BOOT horizontal -->
          <polyline points="108,70 113,63 121,77 129,63 137,77 145,63 153,77 158,70"
            fill="none" stroke="#ff6b35" stroke-width="2.5" filter="url(#gloR)"/>
          <line x1="158" y1="70" x2="180" y2="70" stroke="#ff6b35" stroke-width="2"/>
          <text x="120" y="57" fill="#ff6b35" font-size="9" font-family="Share Tech Mono,monospace" font-weight="bold">R_BOOT</text>
          <text x="120" y="48" fill="#ff2d55" font-size="7" font-family="Share Tech Mono,monospace">← limits I_peak, sets t_r = 2.2·R·C</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  D_BOOT: anode(180,70) → cathode(230,70)  -->
          <!--  Current flows left→right (charge)        -->
          <!-- ══════════════════════════════════════════ -->
          <!-- Diode triangle (anode left, cathode right) -->
          <polygon points="180,58 180,82 205,70" fill="rgba(0,229,255,0.18)" stroke="#00e5ff" stroke-width="1.8"/>
          <line x1="205" y1="58" x2="205" y2="82" stroke="#00e5ff" stroke-width="2.5"/>
          <line x1="205" y1="70" x2="235" y2="70" stroke="#00e5ff" stroke-width="2"/>
          <text x="183" y="95" fill="#00e5ff" font-size="9"  font-family="Share Tech Mono,monospace" font-weight="bold">D_BOOT</text>
          <text x="183" y="107" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">Schottky / fast rec.</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  HB pin node (cathode of D_BOOT)          -->
          <!--  = top of C_BOOT                          -->
          <!-- ══════════════════════════════════════════ -->
          <circle cx="235" cy="70" r="4" fill="#00e5ff" filter="url(#glo)"/>
          <!-- vertical wire down to GATE DRIVER IC HB pin -->
          <line x1="235" y1="70" x2="235" y2="130" stroke="#00e5ff" stroke-width="2"/>

          <!-- ══════════════════════════════════════════ -->
          <!--  GATE DRIVER IC (box)                     -->
          <!-- ══════════════════════════════════════════ -->
          <rect x="195" y="130" width="120" height="120" rx="3"
            fill="rgba(0,229,255,0.05)" stroke="#1a3050" stroke-width="2"/>
          <text x="255" y="150" fill="#8ab4c8" font-size="9" font-family="Share Tech Mono,monospace" text-anchor="middle" font-weight="bold">GATE</text>
          <text x="255" y="162" fill="#8ab4c8" font-size="9" font-family="Share Tech Mono,monospace" text-anchor="middle" font-weight="bold">DRIVER IC</text>
          <text x="255" y="178" fill="#4a6070" font-size="7" font-family="Share Tech Mono,monospace" text-anchor="middle">e.g. IR2110</text>
          <text x="255" y="188" fill="#4a6070" font-size="7" font-family="Share Tech Mono,monospace" text-anchor="middle">UCC27710</text>

          <!-- IC pins labels -->
          <!-- HB pin (top-left of IC) -->
          <text x="198" y="142" fill="#00e5ff" font-size="7" font-family="Share Tech Mono,monospace">HB</text>
          <!-- HS pin (bottom-left of IC) -->
          <text x="198" y="242" fill="#ffcc00" font-size="7" font-family="Share Tech Mono,monospace">HS</text>
          <!-- HO pin (right of IC, high side output) -->
          <text x="320" y="162" fill="#ff6b35" font-size="7" font-family="Share Tech Mono,monospace">HO</text>
          <!-- LO pin (right of IC, low side output) -->
          <text x="320" y="232" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">LO</text>
          <!-- VCC pin -->
          <text x="198" y="195" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">VCC</text>

          <!-- VCC into IC -->
          <line x1="90" y1="70" x2="90" y2="192" stroke="#8ab4c8" stroke-width="1.5" stroke-dasharray="4,3"/>
          <line x1="90"  y1="192" x2="195" y2="192" stroke="#8ab4c8" stroke-width="1.5" stroke-dasharray="4,3"/>

          <!-- ══════════════════════════════════════════ -->
          <!--  C_BOOT: HB(235,70) down to HS(235,248)  -->
          <!-- ══════════════════════════════════════════ -->
          <!-- wire from HB node down to C_BOOT top -->
          <line x1="235" y1="130" x2="235" y2="155" stroke="#00e5ff" stroke-width="2" filter="url(#glo)"/>
          <!-- C_BOOT plates -->
          <line x1="215" y1="155" x2="255" y2="155" stroke="#00e5ff" stroke-width="3.5"/>
          <line x1="215" y1="167" x2="255" y2="167" stroke="#00e5ff" stroke-width="3.5"/>
          <!-- wire C_BOOT bottom to HS node -->
          <line x1="235" y1="167" x2="235" y2="248" stroke="#00e5ff" stroke-width="2" filter="url(#glo)"/>
          <!-- C_BOOT label -->
          <text x="260" y="158" fill="#00e5ff" font-size="10" font-family="Share Tech Mono,monospace" font-weight="bold">C_BOOT</text>
          <text x="260" y="170" fill="#8ab4c8" font-size="7"  font-family="Share Tech Mono,monospace">100nF X7R ceramic</text>
          <!-- + - markers -->
          <text x="208" y="153" fill="#00ff88" font-size="10" font-family="Share Tech Mono,monospace">+</text>
          <text x="208" y="172" fill="#4a6070" font-size="10" font-family="Share Tech Mono,monospace">-</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  HS pin = SW node                         -->
          <!-- ══════════════════════════════════════════ -->
          <!-- HS pin wire from IC bottom-left to SW node -->
          <line x1="195" y1="248" x2="235" y2="248" stroke="#ffcc00" stroke-width="2"/>
          <circle cx="235" cy="248" r="4" fill="#ffcc00" filter="url(#glo)"/>
          <!-- SW node label -->
          <text x="240" y="244" fill="#ffcc00" font-size="8" font-family="Share Tech Mono,monospace" font-weight="bold">SW NODE</text>

          <!-- SW node goes right to connect Q_HS source / Q_LS drain -->
          <line x1="235" y1="248" x2="420" y2="248" stroke="#ffcc00" stroke-width="2.5"/>

          <!-- ══════════════════════════════════════════ -->
          <!--  HO → R_G → Q_HS gate                    -->
          <!-- ══════════════════════════════════════════ -->
          <!-- HO wire out from IC right -->
          <line x1="315" y1="158" x2="350" y2="158" stroke="#ff6b35" stroke-width="2"/>
          <!-- R_G zigzag horizontal -->
          <polyline points="350,158 355,152 363,164 371,152 379,164 387,152 395,164 400,158"
            fill="none" stroke="#ff6b35" stroke-width="2.5" filter="url(#gloR)"/>
          <line x1="400" y1="158" x2="420" y2="158" stroke="#ff6b35" stroke-width="2"/>
          <text x="360" y="147" fill="#ff6b35" font-size="8" font-family="Share Tech Mono,monospace">R_G</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  Q_HS (high side MOSFET)                  -->
          <!--  Drain=HV bus(420,25), Source=SW(420,248) -->
          <!--  Gate=(420,158)                           -->
          <!-- ══════════════════════════════════════════ -->
          <!-- Drain wire -->
          <line x1="420" y1="25"  x2="420" y2="118" stroke="#c77dff" stroke-width="2"/>
          <!-- MOSFET body symbol (N-ch enhancement) -->
          <!-- Drain bar -->
          <line x1="420" y1="118" x2="420" y2="138" stroke="#c77dff" stroke-width="1.5"/>
          <!-- Channel -->
          <line x1="420" y1="138" x2="420" y2="178" stroke="#c77dff" stroke-width="5"/>
          <!-- Gate insulator -->
          <line x1="408" y1="132" x2="408" y2="184" stroke="#c77dff" stroke-width="1.5"/>
          <!-- Gate stub -->
          <line x1="408" y1="158" x2="420" y2="158" stroke="#c77dff" stroke-width="1.5"/>
          <!-- Arrow (N-ch, pointing into channel) -->
          <polygon points="420,183 414,192 426,192" fill="#c77dff"/>
          <!-- Source wire -->
          <line x1="420" y1="192" x2="420" y2="248" stroke="#c77dff" stroke-width="2"/>
          <!-- Body diode Q_HS -->
          <line x1="435" y1="140" x2="435" y2="245" stroke="#c77dff" stroke-width="1" stroke-dasharray="3,3" opacity="0.5"/>
          <!-- MOSFET label -->
          <text x="438" y="155" fill="#c77dff" font-size="9" font-family="Share Tech Mono,monospace" font-weight="bold">Q_HS</text>
          <text x="438" y="167" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">High Side</text>
          <!-- HV bus dot -->
          <circle cx="420" cy="25" r="3" fill="#4a6070"/>

          <!-- ══════════════════════════════════════════ -->
          <!--  Q_LS (low side MOSFET)                   -->
          <!--  Drain=SW(420,248), Source=GND(420,375)   -->
          <!-- ══════════════════════════════════════════ -->
          <line x1="420" y1="248" x2="420" y2="268" stroke="#8ab4c8" stroke-width="2"/>
          <line x1="420" y1="268" x2="420" y2="288" stroke="#8ab4c8" stroke-width="1.5"/>
          <!-- LS channel -->
          <line x1="420" y1="288" x2="420" y2="328" stroke="#8ab4c8" stroke-width="5"/>
          <!-- LS gate insulator -->
          <line x1="408" y1="282" x2="408" y2="334" stroke="#8ab4c8" stroke-width="1.5"/>
          <!-- LS gate stub -->
          <line x1="370" y1="308" x2="408" y2="308" stroke="#8ab4c8" stroke-width="1.5"/>
          <!-- LO from IC -->
          <line x1="315" y1="228" x2="370" y2="228" stroke="#8ab4c8" stroke-width="1.5"/>
          <line x1="370" y1="228" x2="370" y2="308" stroke="#8ab4c8" stroke-width="1.5"/>
          <!-- LS gate R (small, optional) -->
          <text x="330" y="224" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">R_G_LS</text>
          <!-- LS arrow -->
          <polygon points="420,333 414,342 426,342" fill="#8ab4c8"/>
          <!-- LS source to GND -->
          <line x1="420" y1="342" x2="420" y2="375" stroke="#8ab4c8" stroke-width="2"/>
          <circle cx="420" cy="375" r="3" fill="#4a6070"/>
          <!-- LS label -->
          <text x="438" y="305" fill="#8ab4c8" font-size="9" font-family="Share Tech Mono,monospace" font-weight="bold">Q_LS</text>
          <text x="438" y="317" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">Low Side</text>

          <!-- Load / Output label at SW node -->
          <text x="420" y="260" fill="#ffcc00" font-size="7" font-family="Share Tech Mono,monospace" text-anchor="middle">⬆ OUTPUT</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  CHARGE PATH (green dashed arrows)        -->
          <!--  VCC→R_BOOT→D_BOOT→C_BOOT+→C_BOOT-→SW   -->
          <!--  →Q_LS→GND  (when Q_LS ON)               -->
          <!-- ══════════════════════════════════════════ -->
          <!-- arrow along top from VCC to D_BOOT -->
          <line x1="92" y1="67" x2="174" y2="67" stroke="#00ff88" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#aG)"/>
          <!-- arrow from D_BOOT cathode down through C_BOOT -->
          <line x1="235" y1="72" x2="235" y2="152" stroke="#00ff88" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#aG)"/>
          <!-- arrow from C_BOOT- down to SW -->
          <line x1="232" y1="170" x2="232" y2="245" stroke="#00ff88" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#aG)"/>
          <!-- arrow from SW left along bottom through Q_LS to GND -->
          <path d="M 418,250 Q 418,340 418,373" fill="none" stroke="#00ff88" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#aG)"/>
          <!-- Charge path label -->
          <text x="32" y="300" fill="#00ff88" font-size="8" font-family="Share Tech Mono,monospace" transform="rotate(-90,32,300)">CHARGE PATH — Q_LS ON</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  DISCHARGE / EMI PATH (orange dashed)     -->
          <!--  C_BOOT+ → gate driver HB pin → HO →     -->
          <!--  R_G → Q_HS gate → Q_HS channel →        -->
          <!--  SW → C_BOOT-   (when Q_HS turns ON)     -->
          <!-- ══════════════════════════════════════════ -->
          <path d="M 238,158 Q 280,158 348,158" fill="none" stroke="#ff6b35" stroke-width="1.8" stroke-dasharray="5,3" marker-end="url(#aO)"/>
          <path d="M 402,160 Q 417,160 417,192" fill="none" stroke="#ff6b35" stroke-width="1.8" stroke-dasharray="5,3" marker-end="url(#aO)"/>
          <path d="M 417,192 Q 417,248 238,248" fill="none" stroke="#ff6b35" stroke-width="1.8" stroke-dasharray="5,3" marker-end="url(#aO)"/>
          <!-- Discharge label -->
          <text x="320" y="265" fill="#ff6b35" font-size="7" font-family="Share Tech Mono,monospace">di/dt discharge loop</text>

          <!-- ══════════════════════════════════════════ -->
          <!--  PCB LOOP AREA (red dashed box)           -->
          <!--  = C_BOOT → gate driver → R_G → Q_HS     -->
          <!--    gate → Q_HS channel → SW → C_BOOT      -->
          <!-- ══════════════════════════════════════════ -->
          <rect x="192" y="145" width="248" height="115" rx="4"
            fill="rgba(255,45,85,0.04)" stroke="#ff2d55" stroke-width="1.8" stroke-dasharray="7,3"/>
          <text x="196" y="272" fill="#ff2d55" font-size="8" font-family="Share Tech Mono,monospace">PCB LOOP AREA A — minimise to reduce EMI   E ∝ A · I · f²</text>

          <!-- EMI radiation arcs from loop centre -->
          <path d="M 340,190 Q 362,173 362,193 Q 362,213 340,200" fill="none" stroke="#ff2d55" stroke-width="1.5" opacity="0.8"/>
          <path d="M 340,190 Q 380,165 380,193 Q 380,221 340,200" fill="none" stroke="#ff2d55" stroke-width="1.2" opacity="0.5"/>
          <path d="M 340,190 Q 400,155 400,193 Q 400,231 340,200" fill="none" stroke="#ff2d55" stroke-width="1"   opacity="0.3"/>
          <text x="406" y="183" fill="#ff2d55" font-size="8" font-family="Share Tech Mono,monospace">EMI</text>

          <!-- di/dt annotation -->
          <text x="197" y="140" fill="#ffcc00" font-size="7" font-family="Share Tech Mono,monospace">di/dt = V/(2.2·R_BOOT²·C_BOOT)</text>

          <!-- State annotations -->
          <text x="32" y="350" fill="#00ff88"  font-size="7" font-family="Share Tech Mono,monospace">① Q_LS ON  → SW=GND → C_BOOT charges via D_BOOT</text>
          <text x="32" y="362" fill="#ff6b35" font-size="7" font-family="Share Tech Mono,monospace">② Q_HS ON → C_BOOT discharges → fast I through loop → EMI</text>

        </svg>

        <!-- Two callout boxes below SVG -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
          <div style="background:rgba(255,45,85,0.08);border:1px solid rgba(255,45,85,0.3);border-radius:3px;padding:9px 10px;">
            <div style="font-family:'Orbitron',monospace;font-size:8px;color:var(--danger);letter-spacing:1px;margin-bottom:4px;">R_BOOT TOO SMALL</div>
            <div style="font-size:10px;color:#8ab4c8;">Fast edge → high I_peak → large EMI &amp; V<sub>DS</sub> spike from L·di/dt in the loop</div>
          </div>
          <div style="background:rgba(255,204,0,0.06);border:1px solid rgba(255,204,0,0.25);border-radius:3px;padding:9px 10px;">
            <div style="font-family:'Orbitron',monospace;font-size:8px;color:var(--warn);letter-spacing:1px;margin-bottom:4px;">R_BOOT TOO LARGE</div>
            <div style="font-size:10px;color:#8ab4c8;">Slow C_BOOT recharge → bootstrap UVLO risk at high duty cycle · P<sub>R</sub> = ½C·V²·f₀</div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- END PROBLEM STATEMENT -->

          <text x="300" y="294" fill="#8ab4c8" font-size="7"  font-family="Share Tech Mono,monospace">Low Side</text>
          <polygon points="290,312 284,319 296,319" fill="#8ab4c8"/>
          <!-- LS gate driver input (simple line) -->
          <line x1="230" y1="288" x2="260" y2="288" stroke="#8ab4c8" stroke-width="1.5" stroke-dasharray="4,2"/>
          <text x="162" y="293" fill="#8ab4c8" font-size="7" font-family="Share Tech Mono,monospace">LS gate drive</text>

          <!-- GND connection for LS source -->
          <circle cx="290" cy="350" r="3" fill="#4a6070"/>

          <!-- ═══ LOAD (between VCC and SW, or SW and GND — half bridge output) ═══ -->
          <!-- Output taken from SW node -->
          <line x1="380" y1="228" x2="380" y2="228" stroke="#00ff88" stroke-width="1.5"/>
          <!-- output label -->
          <text x="305" y="222" fill="#ffcc00" font-size="8" font-family="Share Tech Mono,monospace">V_SW (output)</text>

          <!-- ═══ CHARGE PATH annotation (green dashed) — when LS is ON ═══ -->
          <!-- Path: VCC(80,20) → D_BOOT → R_BOOT → C_BOOT top → C_BOOT → SW(80,228) → LS drain → GND -->
          <path d="M 75,20 Q 50,20 50,178 Q 50,228 75,228"
            fill="none" stroke="#00ff88" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arG)"/>
          <text x="12" y="120" fill="#00ff88" font-size="8" font-family="Share Tech Mono,monospace" transform="rotate(-90,12,120)">CHARGE PATH (LS ON)</text>

          <!-- ═══ DISCHARGE / EMI PATH annotation (orange dashed) ═══ -->
          <!-- When HS turns ON: CBOOT+ (VBOOT,80,178) → R_G → HS gate → HS channel → SW node → CBOOT- -->
          <path d="M 82,185 Q 160,185 160,180 Q 200,155 258,180"
            fill="none" stroke="#ff6b35" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arO)"/>

          <!-- ═══ PCB LOOP AREA (dashed red box) ═══ -->
          <!-- The fast-discharge loop: CBOOT → RBOOT → RG → HS gate → HS channel → SW → CBOOT -->
          <rect x="56" y="170" width="240" height="70" rx="3"
            fill="rgba(255,45,85,0.04)" stroke="#ff2d55" stroke-width="1.5" stroke-dasharray="6,3"/>
          <text x="60" y="250" fill="#ff2d55" font-size="8" font-family="Share Tech Mono,monospace">PCB LOOP AREA A — fast di/dt path → radiates EMI</text>

          <!-- EMI radiation arcs from loop -->
          <path d="M 170,168 Q 192,148 192,168 Q 192,188 170,175" fill="none" stroke="#ff2d55" stroke-width="1.5" opacity="0.8"/>
          <path d="M 170,168 Q 210,140 210,168 Q 210,196 170,175" fill="none" stroke="#ff2d55" stroke-width="1.2" opacity="0.55"/>
          <path d="M 170,168 Q 228,130 228,168 Q 228,206 170,175" fill="none" stroke="#ff2d55" stroke-width="1"   opacity="0.3"/>
          <text x="232" y="148" fill="#ff2d55" font-size="8" font-family="Share Tech Mono,monospace">EMI &#8733; A&#183;I&#183;f&#178;</text>

          <!-- di/dt label -->
          <text x="120" y="167" fill="#ffcc00" font-size="7" font-family="Share Tech Mono,monospace">di/dt = I&#8346;/t&#7523; = V/(2.2R&#178;C)</text>

          <!-- State labels -->
          <text x="340" y="60"  fill="#4a6070" font-size="8" font-family="Share Tech Mono,monospace">HS ON</text>
          <text x="340" y="72"  fill="#4a6070" font-size="8" font-family="Share Tech Mono,monospace">&#8593; switching</text>
          <text x="340" y="310" fill="#4a6070" font-size="8" font-family="Share Tech Mono,monospace">LS ON</text>
          <text x="340" y="322" fill="#4a6070" font-size="8" font-family="Share Tech Mono,monospace">&#8593; charges C</text>

        </svg>

        <!-- Two callout boxes below SVG -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
          <div style="background:rgba(255,45,85,0.08);border:1px solid rgba(255,45,85,0.3);border-radius:3px;padding:9px 10px;">
            <div style="font-family:'Orbitron',monospace;font-size:8px;color:var(--danger);letter-spacing:1px;margin-bottom:4px;">R<sub>BOOT</sub> TOO SMALL</div>
            <div style="font-size:10px;color:#8ab4c8;">Fast edge &rarr; high I &rarr; large EMI &amp; V<sub>DS</sub> spike from L&middot;di/dt in loop</div>
          </div>
          <div style="background:rgba(255,204,0,0.06);border:1px solid rgba(255,204,0,0.25);border-radius:3px;padding:9px 10px;">
            <div style="font-family:'Orbitron',monospace;font-size:8px;color:var(--warn);letter-spacing:1px;margin-bottom:4px;">R<sub>BOOT</sub> TOO LARGE</div>
            <div style="font-size:10px;color:#8ab4c8;">Slow HS gate drive &rarr; increased switching loss &middot; P<sub>R</sub> = &frac12;C<sub>BOOT</sub>V&sup2;f<sub>0</sub></div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- END PROBLEM STATEMENT -->



  <div class="layout">
    <!-- LEFT: Controls -->
    <div>
      <div class="panel">
        <div class="panel-title">▸ CIRCUIT PARAMETERS</div>

        <div class="param-group">
          <div class="param-label">
            <span>LOOP AREA (A)</span>
            <span id="areaVal">10.0 cm²</span>
          </div>
          <input type="range" id="area" min="0.5" max="100" step="0.5" value="10" oninput="update()">
          <div class="param-range-labels"><span>0.5 cm²</span><span>100 cm²</span></div>
        </div>

        <!-- RC Circuit inputs -->
        <div style="font-family:'Orbitron',monospace;font-size:9px;color:var(--accent);letter-spacing:2px;margin-bottom:12px;opacity:0.7;">▸ RC DISCHARGE SOURCE</div>

        <div class="param-group">
          <div class="param-label">
            <span>CAP VOLTAGE (V)</span>
            <span id="voltVal">24.0 V</span>
          </div>
          <input type="range" id="volt" min="1" max="100" step="1" value="24" oninput="update()">
          <div class="param-range-labels"><span>1 V</span><span>100 V</span></div>
        </div>

        <div class="param-group">
          <div class="param-label">
            <span>SERIES RESISTOR (R)</span>
            <span id="resVal">1.6 Ω</span>
          </div>
          <input type="range" id="res" min="0.1" max="50" step="0.1" value="1.6" oninput="update()">
          <div class="param-range-labels"><span>0.1 Ω</span><span>50 Ω</span></div>
        </div>

        <div class="param-group">
          <div class="param-label">
            <span>CAPACITANCE (C)</span>
            <span id="capVal">100 nF</span>
          </div>
          <input type="range" id="cap" min="1" max="10000" step="1" value="100" oninput="update()">
          <div class="param-range-labels"><span>1 nF</span><span>10 µF</span></div>
        </div>

        <!-- RC derived values box -->
        <div style="background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.2);border-radius:2px;padding:10px 12px;margin-bottom:16px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 12px;">
            <div>
              <div style="font-size:9px;color:#8ab4c8;letter-spacing:1px;margin-bottom:2px;">I_PEAK = V / R</div>
              <div id="rcPeak" style="font-family:'Orbitron',monospace;font-size:14px;color:var(--accent2);font-weight:700;">—</div>
            </div>
            <div>
              <div style="font-size:9px;color:#8ab4c8;letter-spacing:1px;margin-bottom:2px;">τ = R · C</div>
              <div id="rcTau" style="font-family:'Orbitron',monospace;font-size:14px;color:var(--warn);font-weight:700;">—</div>
            </div>
            <div>
              <div style="font-size:9px;color:#8ab4c8;letter-spacing:1px;margin-bottom:2px;">tᵣ = 2.2 · R · C</div>
              <div id="rcTr" style="font-family:'Orbitron',monospace;font-size:14px;color:var(--safe);font-weight:700;">—</div>
            </div>
            <div>
              <div style="font-size:9px;color:#8ab4c8;letter-spacing:1px;margin-bottom:2px;">½ C V²</div>
              <div id="rcEnergy" style="font-family:'Orbitron',monospace;font-size:13px;color:#c77dff;font-weight:700;">—</div>
            </div>
          </div>
        </div>

        <div class="param-group">
          <div class="param-label">
            <span>SWITCHING FREQ (f₀)</span>
            <span id="freqVal">200 kHz</span>
          </div>
          <input type="range" id="freq" min="10" max="2000" step="10" value="200" oninput="update()">
          <div class="param-range-labels"><span>10 kHz</span><span>2 MHz</span></div>
        </div>

        <div class="param-group">
          <div class="param-label">
            <span>MEASUREMENT DIST (r)</span>
            <span id="distVal">3.0 m</span>
          </div>
          <input type="range" id="dist" min="0.1" max="10" step="0.1" value="3" oninput="update()">
          <div class="param-range-labels"><span>0.1 m</span><span>10 m</span></div>
        </div>

        <hr class="divider">
        <div class="panel-title">▸ DERIVED VALUES</div>

        <div class="result-row">
          <span class="result-label">di/dt</span>
          <span class="result-val" id="didt" style="color:var(--accent2)">—</span>
        </div>
        <div class="result-row">
          <span class="result-label">DIPOLE MOMENT (m)</span>
          <span class="result-val" id="moment" style="color:var(--accent)">—</span>
        </div>
        <div class="result-row">
          <span class="result-label">LOOP INDUCTANCE (est.)</span>
          <span class="result-val" id="linduc" style="color:var(--warn)">—</span>
        </div>

        <div class="info-box">
          <strong>I_peak = V / R &nbsp;·&nbsp; tᵣ = 2.2·R·C</strong><br>
          <strong>E(f) = 131×10⁻¹⁶ · A · I · f² / r</strong><br>
          Harmonics: I_n via trapezoidal envelope model<br>
          CISPR Class B limit @ 3m: <strong>40 dBμV/m</strong>
        </div>
      </div>
    </div>

    <!-- RIGHT: Visualizations -->
    <div style="display:flex; flex-direction:column; gap:16px;">

      <!-- Fundamental E-field gauge -->
      <div class="panel">
        <div class="panel-title">▸ RADIATED E-FIELD vs CISPR CLASS B LIMIT</div>

        <div class="gauge-container" style="margin-top:24px;">
          <div class="gauge-label">FUNDAMENTAL (f₀)</div>
          <div class="gauge-bar">
            <div class="gauge-fill" id="gauge1"></div>
            <div class="limit-marker" id="limitMark1">
              <span class="limit-marker-label">LIMIT</span>
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--dim);margin-top:3px;">
            <span>0 dBμV/m</span><span id="g1val" style="color:var(--accent);font-size:11px;"></span><span>80 dBμV/m</span>
          </div>
        </div>

        <div id="harmGauges"></div>

        <div id="statusBadge" class="status-badge" style="margin-top:12px;"></div>
      </div>

      <!-- Harmonic spectrum chart -->
      <div class="panel">
        <div class="panel-title">▸ HARMONIC SPECTRUM (1st → 5th)</div>
        <div class="chart-container">
          <canvas id="spectrumChart" height="200"></canvas>
        </div>
        <div class="legend" id="specLegend"></div>
      </div>

      <!-- Loop visual + field map -->
      <div class="panel">
        <div class="panel-title">▸ LOOP GEOMETRY & FIELD INTENSITY</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div>
            <div class="chart-title">CURRENT LOOP REPRESENTATION</div>
            <div class="loop-visual">
              <svg id="loopSvg" viewBox="0 0 200 160" style="width:100%;height:100%;"></svg>
            </div>
          </div>
          <div>
            <div class="chart-title">FIELD GRADIENT (log scale)</div>
            <canvas id="fieldCanvas" height="160" style="height:160px;"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const CISPR_LIMIT_DBuVm = 40; // dBμV/m at 3m for CISPR Class B (30MHz+, but we use as reference)
const CISPR_LIMIT_VpM = Math.pow(10, CISPR_LIMIT_DBuVm / 20) * 1e-6; // in V/m

// Harmonic colors
const harmColors = ['#00e5ff','#ff6b35','#ffcc00','#00ff88','#c77dff'];
const harmLabels = ['1st','2nd','3rd','4th','5th'];

function getParams() {
  const V   = parseFloat(document.getElementById('volt').value);
  const R   = parseFloat(document.getElementById('res').value);
  const C   = parseFloat(document.getElementById('cap').value) * 1e-9; // nF → F
  const I   = V / R;           // peak current from RC discharge
  const tau = R * C;           // time constant
  const tr  = 2.2 * tau;       // 10-90% rise time
  return {
    A:  parseFloat(document.getElementById('area').value) * 1e-4,
    I, V, R, C, tau, tr,
    f0: parseFloat(document.getElementById('freq').value) * 1e3,
    r:  parseFloat(document.getElementById('dist').value)
  };
}

// E-field for harmonic n
function calcE(A, I_n, fn, r) {
  return (131e-16 * A * I_n * fn * fn) / r;
}

// Harmonic current amplitude (trapezoidal approximation)
function harmonicCurrent(I, n, f0, tr) {
  // For trapezoidal: I_n = I * (2/(n*pi)) * |sin(n*pi*tr*f0)| / (n*pi*tr*f0)
  const arg = n * Math.PI * tr * f0;
  const sinc = arg < 1e-9 ? 1 : Math.sin(arg) / arg;
  return I * (2 / (n * Math.PI)) * Math.abs(sinc);
}

function toDBuVm(E_Vpm) {
  if (E_Vpm <= 0) return -100;
  return 20 * Math.log10(E_Vpm / 1e-6);
}

function update() {
  const p = getParams();

  // Update display labels
  document.getElementById('areaVal').textContent = (p.A * 1e4).toFixed(1) + ' cm²';
  document.getElementById('voltVal').textContent = p.V.toFixed(1) + ' V';
  document.getElementById('resVal').textContent  = p.R.toFixed(1) + ' Ω';
  // Cap display: show nF or µF
  const capNF = p.C * 1e9;
  document.getElementById('capVal').textContent  = capNF >= 1000 ? (capNF/1000).toFixed(2) + ' µF' : capNF.toFixed(0) + ' nF';
  document.getElementById('freqVal').textContent = (p.f0 / 1e3).toFixed(0) + ' kHz';
  document.getElementById('distVal').textContent = p.r.toFixed(1) + ' m';

  // RC derived box
  document.getElementById('rcPeak').textContent   = p.I.toFixed(2) + ' A';
  const tauUs = p.tau * 1e6;
  document.getElementById('rcTau').textContent    = tauUs >= 1 ? tauUs.toFixed(2) + ' µs' : (p.tau*1e9).toFixed(1) + ' ns';
  const trNs = p.tr * 1e9;
  document.getElementById('rcTr').textContent     = trNs >= 1000 ? (trNs/1000).toFixed(2) + ' µs' : trNs.toFixed(1) + ' ns';
  const energy = 0.5 * p.C * p.V * p.V;
  document.getElementById('rcEnergy').textContent = energy >= 1e-3 ? (energy*1e3).toFixed(2) + ' mJ' : (energy*1e6).toFixed(1) + ' µJ';

  // Derived display
  const didt = p.I / p.tr;
  document.getElementById('didt').textContent = didt >= 1e6 ? (didt/1e6).toFixed(2) + ' MA/s' : (didt/1e3).toFixed(1) + ' kA/s';
  document.getElementById('moment').textContent = (p.I * p.A * 1e6).toFixed(3) + ' μA·m²';
  // Simple square loop inductance estimate: L ≈ μ₀*sqrt(A)/pi * (ln(sqrt(A)/w) + ...) rough = 10nH per cm
  const side = Math.sqrt(p.A * 1e4); // cm
  const L_est = side * 1e-8; // rough: 10nH/cm
  document.getElementById('linduc').textContent = (L_est * 1e9).toFixed(1) + ' nH';

  // Update slider track fill
  ['area','volt','res','cap','freq','dist'].forEach(id => {
    const el = document.getElementById(id);
    const pct = ((el.value - el.min) / (el.max - el.min)) * 100;
    el.style.setProperty('--pct', pct + '%');
  });

  // Compute harmonics
  const harmonics = [];
  for (let n = 1; n <= 5; n++) {
    const fn = n * p.f0;
    const I_n = harmonicCurrent(p.I, n, p.f0, p.tr);
    const E = calcE(p.A, I_n, fn, p.r);
    const dB = toDBuVm(E);
    harmonics.push({ n, fn, I_n, E, dB });
  }

  // Update gauges
  const maxDB = 80;
  const limitPct = (CISPR_LIMIT_DBuVm / maxDB) * 100;

  // Fundamental gauge
  const h1 = harmonics[0];
  updateGauge('gauge1', 'g1val', 'limitMark1', h1, maxDB, limitPct);

  // Build harmonic gauges dynamically
  const container = document.getElementById('harmGauges');
  container.innerHTML = '';
  for (let i = 1; i < 5; i++) {
    const h = harmonics[i];
    const div = document.createElement('div');
    div.className = 'gauge-container';
    div.innerHTML = `
      <div class="gauge-label">${harmLabels[i]} HARMONIC (${(h.fn/1e3).toFixed(0)} kHz)</div>
      <div class="gauge-bar" style="height:18px;">
        <div id="hg${i}" style="height:100%;border-radius:2px;transition:width 0.3s,background 0.3s;position:relative;"></div>
        <div style="position:absolute;top:0;bottom:0;left:${limitPct}%;width:2px;background:var(--warn);box-shadow:0 0 6px var(--warn);"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--dim);margin-top:2px;">
        <span style="color:${harmColors[i]};font-size:10px;">${h.dB.toFixed(1)} dBμV/m</span>
        <span>${(h.I_n).toFixed(2)} A</span>
      </div>
    `;
    container.appendChild(div);
    const fill = div.querySelector(`#hg${i}`);
    const pct = Math.min(100, Math.max(0, (h.dB / maxDB) * 100));
    const over = h.dB >= CISPR_LIMIT_DBuVm;
    fill.style.width = pct + '%';
    fill.style.background = over
      ? `linear-gradient(90deg, #ff2d55aa, #ff2d55)`
      : `linear-gradient(90deg, ${harmColors[i]}66, ${harmColors[i]})`;
  }

  // Overall status
  const worst = Math.max(...harmonics.map(h => h.dB));
  const badge = document.getElementById('statusBadge');
  if (worst < CISPR_LIMIT_DBuVm - 10) {
    badge.textContent = '✓ COMPLIANT — MARGIN > 10dB';
    badge.style.background = 'rgba(0,255,136,0.1)';
    badge.style.color = 'var(--safe)';
    badge.style.border = '1px solid var(--safe)';
  } else if (worst < CISPR_LIMIT_DBuVm) {
    badge.textContent = '⚠ MARGINAL — WITHIN LIMIT';
    badge.style.background = 'rgba(255,204,0,0.1)';
    badge.style.color = 'var(--warn)';
    badge.style.border = '1px solid var(--warn)';
  } else {
    badge.textContent = '✗ EXCEEDS CISPR LIMIT';
    badge.style.background = 'rgba(255,45,85,0.1)';
    badge.style.color = 'var(--danger)';
    badge.style.border = '1px solid var(--danger)';
  }

  drawSpectrum(harmonics);
  drawLoop(p);
  drawFieldGradient(harmonics[0].E, p.r);
}

function updateGauge(fillId, valId, markId, h, maxDB, limitPct) {
  const fill = document.getElementById(fillId);
  const val = document.getElementById(valId);
  const mark = document.getElementById(markId);
  const pct = Math.min(100, Math.max(0, (h.dB / maxDB) * 100));
  const over = h.dB >= CISPR_LIMIT_DBuVm;
  fill.style.width = pct + '%';
  fill.style.background = over
    ? 'linear-gradient(90deg, #ff2d55aa, #ff2d55)'
    : `linear-gradient(90deg, ${harmColors[0]}44, ${harmColors[0]})`;
  val.textContent = h.dB.toFixed(1) + ' dBμV/m';
  val.style.color = over ? 'var(--danger)' : harmColors[0];
  mark.style.left = limitPct + '%';
}

function drawSpectrum(harmonics) {
  const canvas = document.getElementById('spectrumChart');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.parentElement.offsetWidth;
  const H = 200;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const pad = { top: 20, right: 20, bottom: 40, left: 50 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  ctx.clearRect(0, 0, W, H);

  // Grid
  ctx.strokeStyle = 'rgba(26,45,64,0.8)';
  ctx.lineWidth = 1;
  for (let db = 0; db <= 80; db += 10) {
    const y = pad.top + ch - (db / 80) * ch;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
    ctx.fillStyle = '#8ab4c8';
    ctx.font = '9px Share Tech Mono';
    ctx.fillText(db, pad.left - 28, y + 3);
  }

  // CISPR limit line
  const limitY = pad.top + ch - (CISPR_LIMIT_DBuVm / 80) * ch;
  ctx.strokeStyle = '#ffcc0088';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([6, 4]);
  ctx.beginPath(); ctx.moveTo(pad.left, limitY); ctx.lineTo(pad.left + cw, limitY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#ffcc00';
  ctx.font = '9px Share Tech Mono';
  ctx.fillText('CISPR LIMIT', pad.left + 4, limitY - 4);

  // Bars
  const barW = (cw / 5) * 0.55;
  const gap = cw / 5;

  harmonics.forEach((h, i) => {
    const x = pad.left + gap * i + gap * 0.225;
    const dbClamped = Math.max(0, h.dB);
    const barH = (dbClamped / 80) * ch;
    const y = pad.top + ch - barH;
    const over = h.dB >= CISPR_LIMIT_DBuVm;
    const color = over ? '#ff2d55' : harmColors[i];

    // Glow
    ctx.shadowColor = color;
    ctx.shadowBlur = over ? 20 : 10;

    const grad = ctx.createLinearGradient(x, y, x, pad.top + ch);
    grad.addColorStop(0, color);
    grad.addColorStop(1, color + '22');
    ctx.fillStyle = grad;
    ctx.fillRect(x, y, barW, barH);
    ctx.shadowBlur = 0;

    // Top value
    ctx.fillStyle = color;
    ctx.font = 'bold 9px Share Tech Mono';
    ctx.textAlign = 'center';
    ctx.fillText(h.dB.toFixed(0) + ' dB', x + barW / 2, y - 4);

    // X label
    ctx.fillStyle = '#8ab4c8';
    ctx.fillText(`${(h.fn / 1e3).toFixed(0)}k`, x + barW / 2, H - pad.bottom + 24);
  });

  // Y axis label
  ctx.fillStyle = '#8ab4c8';
  ctx.font = '9px Share Tech Mono';
  ctx.textAlign = 'left';
  ctx.save();
  ctx.translate(10, pad.top + ch / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.textAlign = 'center';
  ctx.fillText('dBμV/m', 0, 0);
  ctx.restore();
}

function drawLoop(p) {
  const svg = document.getElementById('loopSvg');
  const side = Math.sqrt(p.A * 1e4); // cm
  const maxSide = 10; // cm = 100cm² max
  const scaledSide = (side / maxSide) * 80 + 10;
  const cx = 100, cy = 80;
  const hw = scaledSide / 2;

  // Current flow indicator color
  const didt = p.I / p.tr;
  const intensity = Math.min(1, didt / 5e8);
  const r = Math.round(255 * intensity);
  const g = Math.round(229 * (1 - intensity));
  const strokeCol = `rgb(${r},${g},255)`;

  svg.innerHTML = `
    <defs>
      <marker id="arr" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto">
        <path d="M0,0 L6,3 L0,6 Z" fill="${strokeCol}"/>
      </marker>
      <filter id="glow">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <!-- Field area fill -->
    <rect x="${cx-hw}" y="${cy-hw}" width="${scaledSide}" height="${scaledSide}" 
          fill="rgba(0,229,255,0.04)" stroke="none"/>
    <!-- Loop -->
    <rect x="${cx-hw}" y="${cy-hw}" width="${scaledSide}" height="${scaledSide}" 
          fill="none" stroke="${strokeCol}" stroke-width="2.5" filter="url(#glow)"
          stroke-dasharray="${scaledSide*2},0"/>
    <!-- Current arrows -->
    <line x1="${cx}" y1="${cy-hw}" x2="${cx+1}" y2="${cy-hw}" 
          stroke="${strokeCol}" stroke-width="2" marker-end="url(#arr)"/>
    <!-- Area label -->
    <text x="${cx}" y="${cy+4}" text-anchor="middle" fill="${strokeCol}" font-size="10" opacity="0.8">
      ${side.toFixed(1)} × ${side.toFixed(1)} cm
    </text>
    <!-- Corner dots -->
    <circle cx="${cx-hw}" cy="${cy-hw}" r="3" fill="${strokeCol}" opacity="0.8"/>
    <circle cx="${cx+hw}" cy="${cy-hw}" r="3" fill="${strokeCol}" opacity="0.8"/>
    <circle cx="${cx+hw}" cy="${cy+hw}" r="3" fill="${strokeCol}" opacity="0.8"/>
    <circle cx="${cx-hw}" cy="${cy+hw}" r="3" fill="${strokeCol}" opacity="0.8"/>
    <!-- Dimension lines -->
    <line x1="${cx-hw}" y1="${cy+hw+8}" x2="${cx+hw}" y2="${cy+hw+8}" stroke="#2a4050" stroke-width="1"/>
    <text x="${cx}" y="${cy+hw+20}" text-anchor="middle" fill="#8ab4c8" font-size="8">
      A = ${(p.A*1e4).toFixed(1)} cm²
    </text>
    <!-- di/dt indicator -->
    <text x="${cx}" y="14" text-anchor="middle" fill="#ff6b35" font-size="9">
      di/dt = ${(p.I/p.tr/1e6).toFixed(0)} MA/s
    </text>
  `;
}

function drawFieldGradient(E_fund, r) {
  const canvas = document.getElementById('fieldCanvas');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.parentElement ? canvas.parentElement.offsetWidth / 2 - 10 : 200;
  const H = 160;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = (W) + 'px';
  canvas.style.height = H + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  // Draw radial field strength gradient from center
  const cx = W * 0.3, cy = H * 0.5;
  const maxR = Math.min(W, H) * 0.85;

  // Field at distance d scales as 1/d from source
  for (let px = 0; px < W; px++) {
    for (let py = 0; py < H; py++) {
      const dx = px - cx, dy = py - cy;
      const d = Math.sqrt(dx * dx + dy * dy) || 0.1;
      const scaledR = (d / maxR) * 10; // 0 to 10m
      const E_here = (E_fund * r) / scaledR;
      const ratio = Math.min(1, E_here / (CISPR_LIMIT_VpM * 2));
      // Color: green → yellow → red
      let red, green, blue;
      if (ratio < 0.5) {
        red = Math.round(ratio * 2 * 255);
        green = 200;
        blue = 80;
      } else {
        red = 255;
        green = Math.round((1 - (ratio - 0.5) * 2) * 200);
        blue = 0;
      }
      ctx.fillStyle = `rgba(${red},${green},${blue},0.85)`;
      ctx.fillRect(px, py, 1, 1);
    }
  }

  // Draw measurement distance marker
  const measPixR = (r / 10) * maxR;
  ctx.strokeStyle = 'rgba(255,204,0,0.8)';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([4, 3]);
  ctx.beginPath();
  ctx.arc(cx, cy, measPixR, 0, Math.PI * 2);
  ctx.stroke();
  ctx.setLineDash([]);

  // CISPR compliance circle
  // Find the radius where E = CISPR limit
  const complianceR = (E_fund * r) / CISPR_LIMIT_VpM;
  const compPixR = Math.min(maxR * 1.5, (complianceR / 10) * maxR);
  if (compPixR > 2 && compPixR < maxR * 1.5) {
    ctx.strokeStyle = 'rgba(255,255,255,0.4)';
    ctx.lineWidth = 1;
    ctx.setLineDash([2, 2]);
    ctx.beginPath();
    ctx.arc(cx, cy, Math.min(compPixR, maxR), 0, Math.PI * 2);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Loop at center
  ctx.fillStyle = '#00e5ff';
  ctx.shadowColor = '#00e5ff';
  ctx.shadowBlur = 12;
  ctx.fillRect(cx - 5, cy - 5, 10, 10);
  ctx.shadowBlur = 0;

  // Labels
  ctx.fillStyle = '#ffcc00';
  ctx.font = `${8 * dpr / dpr}px Share Tech Mono`;
  ctx.fillText(`${r.toFixed(1)}m`, cx + measPixR + 3, cy - 3);
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.fillText('LOOP', cx - 12, cy + 18);
}

// Initial render
update();
window.addEventListener('resize', () => {
  const p = getParams();
  const harmonics = [];
  for (let n = 1; n <= 5; n++) {
    const fn = n * p.f0;
    const I_n = harmonicCurrent(p.I, n, p.f0, p.tr);
    const E = calcE(p.A, I_n, fn, p.r);
    harmonics.push({ n, fn, I_n, E, dB: toDBuVm(E) });
  }
  drawSpectrum(harmonics);
  drawFieldGradient(harmonics[0].E, p.r);
});

function toggleRef() {
  const panel = document.getElementById('refPanel');
  const arrow = document.getElementById('refArrow');
  const btn   = document.getElementById('refToggleBtn');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    arrow.textContent = 'COLLAPSE ↑';
    btn.style.borderColor = 'var(--accent)';
    btn.style.borderRadius = '4px 4px 0 0';
  } else {
    panel.style.display = 'none';
    arrow.textContent = 'EXPAND ↓';
    btn.style.borderColor = 'var(--border)';
    btn.style.borderRadius = '4px';
  }
}
</script>

<style>
.ref-block {
  background: rgba(0,229,255,0.03);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 16px 18px;
}
.ref-title {
  font-family: 'Orbitron', monospace;
  font-size: 10px;
  color: var(--accent);
  letter-spacing: 2px;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.ref-body {
  font-size: 11.5px;
  color: #8ab4c8;
  line-height: 1.8;
}
.eq {
  display: block;
  font-family: 'Share Tech Mono', monospace;
  color: #e0f4ff;
  background: rgba(0,0,0,0.3);
  border-left: 2px solid var(--accent);
  padding: 3px 10px;
  margin: 4px 0;
  border-radius: 0 2px 2px 0;
  font-size: 12px;
}
.ref-note {
  display: block;
  margin-top: 8px;
  font-size: 10.5px;
  color: var(--dim);
  font-style: italic;
  border-left: 2px solid var(--accent2);
  padding-left: 8px;
  opacity: 0.85;
}
#refToggleBtn:hover {
  border-color: var(--accent) !important;
  background: rgba(0,229,255,0.05);
}
</style>

<div style="max-width:1200px;margin:12px auto 40px auto;padding:0 0px;">
  <button onclick="toggleRef()" id="refToggleBtn"
    style="width:100%;background:var(--panel);border:1px solid var(--border);color:var(--accent);
           font-family:'Orbitron',monospace;font-size:11px;letter-spacing:3px;padding:12px 20px;
           cursor:pointer;text-align:left;border-radius:4px;transition:all 0.2s;outline:none;">
    &#9658; FORMULA REFERENCE &amp; DERIVATION NOTES
    <span id="refArrow" style="float:right;opacity:0.5;font-size:10px;">EXPAND &#8595;</span>
  </button>

  <div id="refPanel" style="display:none;background:var(--panel);border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;padding:20px;">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;">

      <div class="ref-block">
        <div class="ref-title">&#9312; RC DISCHARGE &mdash; PEAK CURRENT &amp; RISE TIME</div>
        <div class="ref-body">
          Capacitor C charged to V discharging through resistor R:<br>
          <span class="eq">I(t) = (V / R) &middot; e<sup>&minus;t/&tau;</sup></span>
          <span class="eq">I<sub>peak</sub> = V / R &nbsp;&nbsp;[at t = 0]</span>
          <span class="eq">&tau; = R &middot; C &nbsp;&nbsp;[time constant, seconds]</span>
          <span class="eq">t<sub>r</sub> = 2.2 &middot; R &middot; C &nbsp;&nbsp;[10%&rarr;90% rise time]</span>
          <span class="eq">di/dt|<sub>peak</sub> = I<sub>peak</sub> / t<sub>r</sub> = V / (2.2 &middot; R&sup2; &middot; C)</span>
          <span class="ref-note">Ceramic caps (X5R/X7R) preferred: very low ESR/ESL lets the RC time constant dominate rise time. Electrolytics add parasitic inductance that distorts the current edge.</span>
        </div>
      </div>

      <div class="ref-block">
        <div class="ref-title">&#9313; MAGNETIC DIPOLE MOMENT</div>
        <div class="ref-body">
          A current loop on PCB acts as a magnetic dipole:<br>
          <span class="eq">m(t) = I(t) &middot; A &nbsp;&nbsp;[A&middot;m&sup2;]</span>
          <span class="eq">m<sub>peak</sub> = I<sub>peak</sub> &middot; A</span>
          Loop area A is enclosed by the high-di/dt current path and its PCB return.<br>
          <span class="ref-note">Minimising loop area is the highest-leverage EMI fix. Placing the return path on the adjacent layer directly beneath the power trace achieves near-field cancellation.</span>
        </div>
      </div>

      <div class="ref-block">
        <div class="ref-title">&#9314; RADIATED E-FIELD &mdash; FAR FIELD FORMULA</div>
        <div class="ref-body">
          From Maxwell's equations for a small magnetic dipole:<br>
          <span class="eq">E = (&mu;<sub>0</sub> &middot; A &middot; I &middot; (2&pi;f)&sup2;) / (4&pi; &middot; r &middot; c)</span>
          Substituting &mu;<sub>0</sub> = 4&pi;&times;10<sup>&minus;7</sup>, c = 3&times;10<sup>8</sup>:<br>
          <span class="eq">E(f) = 131&times;10<sup>&minus;16</sup> &middot; A &middot; I &middot; f&sup2; / r &nbsp;&nbsp;[V/m]</span>
          A [m&sup2;] &middot; I [A] &middot; f [Hz] &middot; r [m]<br>
          <span class="ref-note">Valid for far-field (r &gg; &lambda;/2&pi;). At 200 kHz, &lambda;/2&pi; &asymp; 240 m, so at r = 3 m we are in near-field &mdash; the formula overestimates, giving a conservative safety margin for pre-compliance use.</span>
        </div>
      </div>

      <div class="ref-block">
        <div class="ref-title">&#9315; HARMONIC CURRENT &mdash; TRAPEZOIDAL WAVEFORM</div>
        <div class="ref-body">
          Fourier envelope of n-th harmonic for trapezoidal switching:<br>
          <span class="eq">I<sub>n</sub> = I<sub>peak</sub> &middot; (2/n&pi;) &middot; |sinc(n &middot; &pi; &middot; t<sub>r</sub> &middot; f<sub>0</sub>)|</span>
          where sinc(x) = sin(x)/x. Spectral breakpoints:<br>
          <span class="eq">f<sub>b1</sub> = 1/(&pi; &middot; t<sub>pulse</sub>) &nbsp;[&minus;20 dB/dec starts]</span>
          <span class="eq">f<sub>b2</sub> = 1/(&pi; &middot; t<sub>r</sub>) &nbsp;&nbsp;&nbsp;[&minus;40 dB/dec starts]</span>
          <span class="ref-note">Slowing edges (larger R) raises t_r, pushing f_b2 lower and cutting harmonic content. You get EMI reduction from both lower I_peak and slower edges simultaneously.</span>
        </div>
      </div>

      <div class="ref-block">
        <div class="ref-title">&#9316; E-FIELD PER HARMONIC &amp; KEY SENSITIVITIES</div>
        <div class="ref-body">
          Each harmonic n radiates at f<sub>n</sub> = n&middot;f<sub>0</sub>:<br>
          <span class="eq">E<sub>n</sub> = 131&times;10<sup>&minus;16</sup> &middot; A &middot; I<sub>n</sub> &middot; f<sub>n</sub>&sup2; / r</span>
          With f<sub>n</sub> = n&middot;f<sub>0</sub> and I<sub>n</sub> &prop; 1/n at low harmonics:<br>
          <span class="eq">E<sub>n</sub> &prop; n &middot; f<sub>0</sub>&sup2; &middot; A &middot; I<sub>peak</sub> / r</span>
          <span class="eq">E &prop; f&sup2; &nbsp;(quadratic &mdash; 2&times; freq = 4&times; field)</span>
          <span class="eq">E &prop; A &nbsp;&nbsp;(linear &mdash; half area = half field)</span>
          <span class="eq">E &prop; I &nbsp;&nbsp;(linear &mdash; half current = half field)</span>
          <span class="ref-note">f&sup2; dependence is why higher harmonics often dominate despite lower current amplitude. Always check all harmonics against the limit, not just the fundamental.</span>
        </div>
      </div>

      <div class="ref-block">
        <div class="ref-title">&#9317; dB&micro;V/m CONVERSION &amp; CISPR CLASS B LIMITS</div>
        <div class="ref-body">
          Convert E-field from V/m to dB&micro;V/m:<br>
          <span class="eq">E [dB&micro;V/m] = 20 &middot; log<sub>10</sub>(E [V/m] &times; 10<sup>6</sup>)</span>
          <span class="eq">E [V/m] = 10<sup>(E[dB&micro;V/m]/20)</sup> &times; 10<sup>&minus;6</sup></span>
          CISPR 32 / EN 55032 Class B limits at 3 m measurement distance:<br>
          <span class="eq">30 MHz &ndash; 230 MHz: &nbsp;&nbsp;40 dB&micro;V/m</span>
          <span class="eq">230 MHz &ndash; 1 GHz: &nbsp;47 dB&micro;V/m</span>
          <span class="ref-note">This tool uses 40 dB&micro;V/m as a single conservative reference across all frequencies. For full pre-compliance, apply the correct limit per band per harmonic.</span>
        </div>
      </div>

      <div class="ref-block">
        <div class="ref-title">&#9318; LOOP INDUCTANCE &mdash; PCB TRACE ESTIMATE</div>
        <div class="ref-body">
          For a square loop side s, trace width w:<br>
          <span class="eq">L &asymp; (2&mu;<sub>0</sub>/&pi;) &middot; s &middot; [ln(2s/w) &minus; 0.774]</span>
          Simplified engineering rule:<br>
          <span class="eq">L &asymp; 10 nH per cm of loop perimeter</span>
          Inductive voltage spike at turn-off:<br>
          <span class="eq">V<sub>spike</sub> = L &middot; di/dt = L &middot; I<sub>peak</sub> / t<sub>r</sub></span>
          <span class="ref-note">Example: 15 A, 50 nH loop, 50 ns rise time &rarr; V_spike = 15 V on top of bus voltage. This directly stresses MOSFET V_ds. Reducing loop area fixes both EMI and switch stress simultaneously.</span>
        </div>
      </div>

      <div class="ref-block">
        <div class="ref-title">&#9319; CAPACITOR ENERGY, CHARGE &amp; THERMAL</div>
        <div class="ref-body">
          Energy stored before each discharge:<br>
          <span class="eq">E<sub>stored</sub> = &frac12; &middot; C &middot; V&sup2;</span>
          Charge delivered per cycle:<br>
          <span class="eq">Q = C &middot; V</span>
          Average power dissipated in R at frequency f<sub>0</sub>:<br>
          <span class="eq">P<sub>R</sub> = &frac12; &middot; C &middot; V&sup2; &middot; f<sub>0</sub></span>
          <span class="ref-note">Exactly half the stored energy is lost in R per discharge, regardless of R's value &mdash; a fundamental result of RC circuits. R only controls delivery speed. Use this to size R's power rating for continuous operation.</span>
        </div>
      </div>

    </div>
  </div>
</div>

</body>
</html>
